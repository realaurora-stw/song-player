<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Song Lyrics Mixer</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
        }
        .container {
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        h1 {
            margin-bottom: 25px;
            color: #333;
        }
        .input-group {
            margin-bottom: 20px;
            text-align: left;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }
        input[type="file"] {
            display: block;
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-bottom: 5px; /* Space before status */
        }
         input[type="file"]::file-selector-button {
            padding: 5px 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #eee;
            cursor: pointer;
            margin-right: 10px;
         }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: 1em;
            font-weight: 600;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-top: 10px;
        }
        button:disabled {
            background-color: #aaa;
            cursor: not-allowed;
        }
        button:hover:enabled {
            background-color: #0056b3;
        }
        #status, .file-status {
            margin-top: 5px;
            font-size: 0.9em;
            color: #666;
            min-height: 1.2em; /* Prevent layout shifts */
        }
        #downloadLink {
            display: none; /* Hidden initially */
            margin-top: 20px;
            padding: 10px 20px;
            background-color: #28a745;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            font-weight: 600;
        }
         #downloadLink:hover {
             background-color: #218838;
         }
    </style>
</head>
<body>
    <div class="container">
        <h1>MP3 + JSON Lyrics Mixer</h1>
        <p style="font-size: 0.8em; color: #555; margin-bottom: 15px;">Expects JSON with format: <code>{"segments": [{"words": [{"text": "...", "start": ...}]}]}</code></p>

        <div class="input-group">
            <label for="mp3File">Select MP3 File:</label>
            <input type="file" id="mp3File" accept=".mp3,audio/mpeg">
            <div class="file-status" id="mp3Status"></div>
        </div>

        <div class="input-group">
            <label for="jsonFile">Select JSON Lyrics File:</label>
            <input type="file" id="jsonFile" accept=".json,application/json">
             <div class="file-status" id="jsonStatus"></div>
        </div>

        <button id="combineBtn" disabled>Combine Files</button>
        <div id="status">Select both files to combine.</div>

        <a href="#" id="downloadLink" download="combined.songlyrics">Download Combined File</a>
    </div>

    <script>
        const mp3FileInput = document.getElementById('mp3File');
        const jsonFileInput = document.getElementById('jsonFile');
        const mp3Status = document.getElementById('mp3Status');
        const jsonStatus = document.getElementById('jsonStatus');
        const combineBtn = document.getElementById('combineBtn');
        const statusDiv = document.getElementById('status');
        const downloadLink = document.getElementById('downloadLink');

        let mp3Data = null; // Will hold ArrayBuffer
        let jsonData = null; // Will hold JSON string
        let mp3FileName = 'audio'; // Default base name
        let currentDownloadURL = null;

        function checkFiles() {
            if (mp3Data && jsonData) {
                combineBtn.disabled = false;
                statusDiv.textContent = 'Ready to combine!';
            } else {
                combineBtn.disabled = true;
                 if (!mp3Data && !jsonData) statusDiv.textContent = 'Select both files to combine.';
                 else if (!mp3Data) statusDiv.textContent = 'Waiting for MP3 file.';
                 else statusDiv.textContent = 'Waiting for JSON file.';
                downloadLink.style.display = 'none'; // Hide download link if files change
                 if (currentDownloadURL) {
                     URL.revokeObjectURL(currentDownloadURL); // Clean up old URL
                     currentDownloadURL = null;
                 }
            }
        }

        // NEW: Function to validate the specific JSON structure
        function validateJsonStructure(parsedData) {
            if (typeof parsedData !== 'object' || parsedData === null) {
                return { valid: false, message: "JSON is not an object." };
            }
            if (!Array.isArray(parsedData.segments)) {
                 return { valid: false, message: "Missing or invalid 'segments' array." };
            }
            // Optional: Check structure of the first segment/word if segments exist
            if (parsedData.segments.length > 0) {
                 const firstSegment = parsedData.segments[0];
                 if (typeof firstSegment !== 'object' || firstSegment === null) {
                     return { valid: false, message: "First segment is not an object." };
                 }
                 if (!Array.isArray(firstSegment.words)) {
                    return { valid: false, message: "First segment missing or invalid 'words' array." };
                 }
                 if (firstSegment.words.length > 0) {
                    const firstWord = firstSegment.words[0];
                    if (typeof firstWord !== 'object' || firstWord === null) {
                        return { valid: false, message: "First word in first segment is not an object." };
                    }
                    // Check for essential keys in the first word
                    if (typeof firstWord.text !== 'string') { // New format uses 'text'
                         return { valid: false, message: "First word missing 'text' (string)." };
                    }
                    if (typeof firstWord.start !== 'number') {
                        return { valid: false, message: "First word missing 'start' (number)." };
                    }
                 }
            }
             return { valid: true, message: "JSON structure is valid." };
        }


        mp3FileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                mp3FileName = file.name.replace(/\.[^/.]+$/, ""); // Get name without extension
                const reader = new FileReader();
                reader.onload = (e) => {
                    mp3Data = e.target.result; // result is ArrayBuffer
                    mp3Status.textContent = `Loaded: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`;
                    checkFiles();
                };
                 reader.onerror = () => {
                     mp3Data = null;
                     mp3Status.textContent = 'Error reading MP3 file.';
                     checkFiles();
                 };
                reader.readAsArrayBuffer(file);
                 mp3Status.textContent = 'Loading MP3...';
            } else {
                mp3Data = null;
                 mp3Status.textContent = '';
                checkFiles();
            }
        });

        jsonFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const rawJsonString = e.target.result;
                    try {
                        // 1. Basic parse check
                        const parsedData = JSON.parse(rawJsonString);

                        // 2. Specific structure validation
                        const validationResult = validateJsonStructure(parsedData);
                        if (!validationResult.valid) {
                            throw new Error(validationResult.message); // Throw specific error
                        }

                        jsonData = rawJsonString; // Store the raw string if valid
                        jsonStatus.textContent = `Loaded: ${file.name}`;
                         checkFiles();
                    } catch(error) {
                         jsonData = null;
                         jsonStatus.textContent = `Error: Invalid JSON format or structure. ${error.message}`;
                         checkFiles();
                         alert(`Invalid JSON file: ${error.message}\n\nExpected format: {"segments": [{"words": [{"text": "...", "start": ...}]}]}`);
                    }
                };
                 reader.onerror = () => {
                     jsonData = null;
                     jsonStatus.textContent = 'Error reading JSON file.';
                     checkFiles();
                 };
                reader.readAsText(file); // Read as text
                jsonStatus.textContent = 'Loading JSON...';
            } else {
                 jsonData = null;
                 jsonStatus.textContent = '';
                 checkFiles();
            }
        });

        combineBtn.addEventListener('click', () => {
            if (!mp3Data || !jsonData) {
                statusDiv.textContent = 'Error: Missing files.';
                return;
            }

            statusDiv.textContent = 'Combining...';
            combineBtn.disabled = true;

            try {
                // 1. Convert JSON string to UTF-8 bytes
                const jsonBytes = new TextEncoder().encode(jsonData);
                const jsonLength = jsonBytes.byteLength;

                // 2. Define Magic Bytes ("LYRX")
                const magicBytes = new Uint8Array([76, 89, 82, 88]); // ASCII for L, Y, R, X

                // 3. Calculate total size
                const totalSize = magicBytes.byteLength + 4 + jsonLength + mp3Data.byteLength; // 4 bytes for JSON length

                // 4. Create the combined ArrayBuffer
                const combinedBuffer = new ArrayBuffer(totalSize);
                const combinedView = new DataView(combinedBuffer);
                const combinedBytes = new Uint8Array(combinedBuffer);

                let offset = 0;

                // 5. Write Magic Bytes
                combinedBytes.set(magicBytes, offset);
                offset += magicBytes.byteLength;

                // 6. Write JSON Length (as 32-bit unsigned integer, Big Endian)
                combinedView.setUint32(offset, jsonLength, false); // false for Big Endian
                offset += 4;

                // 7. Write JSON Data
                combinedBytes.set(jsonBytes, offset);
                offset += jsonLength;

                // 8. Write MP3 Data
                combinedBytes.set(new Uint8Array(mp3Data), offset);

                // 9. Create a Blob
                // Use a generic type or a custom one if you plan server-side handling
                const blob = new Blob([combinedBuffer], { type: 'application/octet-stream' });

                // 10. Create download link
                 if (currentDownloadURL) {
                     URL.revokeObjectURL(currentDownloadURL); // Clean up previous one
                 }
                currentDownloadURL = URL.createObjectURL(blob);
                downloadLink.href = currentDownloadURL;
                downloadLink.download = `${mp3FileName}.songlyrics`; // Suggest filename
                downloadLink.style.display = 'inline-block'; // Show the link
                statusDiv.textContent = 'Combination successful! Click the link to download.';

            } catch (error) {
                statusDiv.textContent = `Error during combination: ${error.message}`;
                console.error("Combination Error:", error);
                downloadLink.style.display = 'none';
            } finally {
                 // Re-enable button only if files are still valid (might have changed during process)
                 checkFiles();
            }
        });

    </script>
</body>
</html>